# Гибридный телеграм-бот-аналитик на базе LLM-агента

Этот проект представляет собой телеграм-бота на `aiogram`, который выступает в роли гибридного аналитика истории чата Telegram. Он использует большую языковую модель (LLM) в качестве "мозга" для понимания запросов на естественном языке и выбора подходящего инструмента для ответа: семантический поиск для концептуальных вопросов и SQL-аналитика для точных запросов.

Бот не просто ищет похожие сообщения, а проводит полноценный анализ данных "на лету", комбинируя сильные стороны векторного поиска и прямого доступа к базе данных.

## Принцип работы

Работа бота разделена на два этапа: подготовка данных и обработка запросов с помощью гибридного LLM-агента.

### 1. Подготовка данных (`import_to_db.py`)

Скрипт `import_to_db.py` выполняет две ключевые задачи:

1.  **Создание SQL-базы:** Преобразует историю чата из `chat_history.json` в структурированную базу данных SQLite (`qa.db`). В базе создается детализированная таблица `messages` с полями `message_id`, `author_name`, `message_text`, `timestamp` и др.
2.  **Создание векторного индекса:** Векторизует каждое сообщение из чата с помощью модели `SentenceTransformer` и сохраняет эти векторы в индекс `FAISS` (`qa.index`). Это позволяет выполнять быстрый семантический (смысловой) поиск.

### 2. Работа гибридного агента (`main.py`)

Ядром бота является **гибридный агент**, созданный с помощью фреймворка `LangChain` и модели `Claude 3.5 Sonnet`. Агент владеет двумя инструментами:

-   `smart_semantic_search_chat`: Для открытых, концептуальных вопросов (например, "что думают о новом ресторане?", "посоветуйте стоматолога").
-   `sql_database_query`: Для точных, аналитических запросов (например, "кто написал больше всего сообщений в мае?", "покажи сообщения от Ивана со ссылками").

Когда пользователь отправляет запрос, агент запускает цикл "Мысль-Действие":

1.  **Мысль (Thought):** Агент анализирует вопрос и решает, какой из двух инструментов лучше всего подходит для ответа.
2.  **Действие (Action):** Агент выбирает инструмент (`smart_semantic_search_chat` или `sql_database_query`) и формирует для него входные данные (поисковый запрос или SQL-код).
3.  **Наблюдение (Observation):** Выполняется либо семантический поиск по индексу `FAISS`, либо SQL-запрос к базе `qa.db`. Результат возвращается агенту.
4.  **Финальный ответ (Final Answer):** Агент анализирует полученные данные и генерирует для пользователя итоговый ответ на русском языке.

Все шаги работы агента (его мысли, выбранные действия и полученные данные) для отладки логируются в файлы `agent_verbose.log` и `llm_requests.log`.

## Технологии

-   **Telegram Bot API:** `aiogram`
-   **LLM-фреймворк:** `LangChain`
-   **Языковая модель:** `Claude 3.5 Sonnet`
-   **Хранение данных:** `SQLite`
-   **Векторный поиск:** `FAISS`, `sentence-transformers`
-   **Окружение и зависимости:** `uv`

## Структура проекта

-   `.env`: Файл для хранения токенов и ключей API.
-   `main.py`: Основной файл для запуска бота-агента.
-   `import_to_db.py`: Скрипт для парсинга истории, создания SQL-базы и FAISS-индекса.
-   `chat_history.json`: Экспорт истории чата Telegram.
-   `qa.db`: База данных SQLite с историей сообщений.
-   `qa.index`: Файл индекса FAISS с векторами сообщений.
-   `agent_verbose.log`: Детальный лог работы агента, дублирующий вывод в консоль.
-   `llm_requests.log`: Структурированный лог для анализа запросов к LLM.
-   `pyproject.toml` / `requirements.txt`: Файлы с зависимостями проекта.

## Установка и запуск

1.  **Клонируйте репозиторий и перейдите в него.**

2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    uv venv
    source .venv/bin/activate
    ```

3.  **Установите зависимости:**
    ```bash
    uv pip install -r requirements.txt
    ```

4.  **Создайте файл `.env`** и добавьте в него токен вашего бота и ключ API от Anthropic:
    ```
    TELEGRAM_BOT_TOKEN="ВАШ_ТЕЛЕГРАМ_ТОКЕН"
    ANTHROPIC_API_KEY="ВАШ_ANTHROPIC_КЛЮЧ"
    ```

5.  **Подготовьте данные:**
    Поместите файл `chat_history.json` (экспорт истории из Telegram) в корень проекта и запустите скрипт импорта. Он создаст базу данных `qa.db` и индекс `qa.index`.
    ```bash
    python import_to_db.py
    ```

6.  **Запустите бота:**
    ```bash
    python main.py
    ```