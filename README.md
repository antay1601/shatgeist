# Телеграм-бот-аналитик на базе LLM-агента

Этот проект представляет собой телеграм-бота на `aiogram`, который выступает в роли аналитика истории чата Telegram. Он использует большую языковую модель (LLM) в качестве "мозга" для понимания запросов на естественном языке, самостоятельного написания SQL-запросов к базе данных чата и формирования осмысленных, структурированных ответов.

Бот не ищет похожие сообщения, а проводит полноценный анализ данных "на лету".

## Принцип работы

Работа бота разделена на два этапа: подготовка базы данных и обработка запросов с помощью LLM-агента.

### 1. Подготовка базы данных (`import_to_db.py`)

Скрипт `import_to_db.py` преобразует сырую историю чата из `chat_history.json` в структурированную базу данных SQLite (`qa.db`).

В отличие от предыдущих подходов, здесь не происходит векторизации или поиска пар "вопрос-ответ". Вместо этого создается детализированная таблица `messages`, содержащая множество полей: `message_id`, `thread_id`, `author_name`, `message_text`, `timestamp`, `reply_to_message_id`, `has_media`, `has_links` и другие. Это превращает историю чата в полноценную базу данных, готовую для сложной аналитики.

### 2. Работа SQL-агента (`main.py`)

Ядром бота является **SQL-агент**, созданный с помощью фреймворка `LangChain` и модели `Claude 3.5 Sonnet`.

Когда пользователь отправляет запрос (например, "Кто самый активный участник за последнюю неделю?" или "Покажи сообщения от Ивана, где были ссылки"), агент запускает цикл "Мысль-Действие":

1.  **Мысль (Thought):** Агент анализирует вопрос и решает, как на него ответить с помощью данных из базы.
2.  **Действие (Action):** Агент самостоятельно **генерирует SQL-запрос**, который, по его мнению, позволит извлечь нужную информацию.
3.  **Наблюдение (Observation):** SQL-запрос выполняется в базе `qa.db`, и результат возвращается агенту.
4.  **Финальный ответ (Final Answer):** Агент анализирует полученные данные и генерирует для пользователя итоговый ответ на русском языке, который, согласно заложенным в него инструкциям, состоит из краткой **сводки** и **исходных сообщений**, на которых она основана.

Все шаги работы агента (его мысли, сгенерированный SQL и полученные данные) для отладки логируются в файл `log.md`.

## Технологии

-   **Telegram Bot API:** `aiogram`
-   **LLM-фреймворк:** `LangChain`
-   **Языковая модель:** `Claude 3.5 Sonnet` (через `langchain-anthropic`)
-   **Хранение данных:** `SQLite`
-   **Окружение и зависимости:** `uv`

## Структура проекта

-   `.env`: Файл для хранения токенов и ключей API.
-   `main.py`: Основной файл для запуска бота-агента.
-   `import_to_db.py`: Скрипт для парсинга истории чата и создания базы данных.
-   `chat_history.json`: Экспорт истории чата Telegram.
-   `qa.db`: База данных SQLite с историей сообщений.
-   `log.md`: Лог-файл с записью рассуждений и действий агента.
-   `pyproject.toml` / `requirements.txt`: Файлы с зависимостями проекта.

## Установка и запуск

1.  **Клонируйте репозиторий и перейдите в него.**

2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    uv venv
    source .venv/bin/activate
    ```

3.  **Установите зависимости:**
    ```bash
    uv pip install -r requirements.txt
    ```

4.  **Создайте файл `.env`** и добавьте в него токен вашего бота и ключ API от Anthropic:
    ```
    TELEGRAM_BOT_TOKEN="ВАШ_ТЕЛЕГРАМ_ТОКЕН"
    ANTHROPIC_API_KEY="ВАШ_ANTHROPIC_КЛЮЧ"
    ```

5.  **Создайте базу данных:**
    Поместите файл `chat_history.json` (экспорт истории из Telegram) в корень проекта и запустите скрипт импорта. Этот процесс обычно занимает всего несколько минут.
    ```bash
    python import_to_db.py
    ```

6.  **Запустите бота:**
    После успешного завершения импорта запустите основного бота.
    ```bash
    python main.py
    ```
